# Правила работы с проектом

## Основные правила общения
- Отвечать на русском языке
- Сначала создавать план выполнения задач
- Затем выполнять задачу по плану до конца
- После выполнения проверять ошибки и тестировать код

## Работа с базой данных

### Выполнение SQL запросов:
При необходимости выполнить SQL запросы к базе данных, используй скрипт `scripts/db.js`:
- Для выполнения SQL строки: `node scripts/db.js exec "SQL_QUERY"`
- Для выполнения SQL из файла: `node scripts/db.js file ./path/to/file.sql`
- Требует переменную окружение DATABASE_URL или DIRECT_URL в .env.local
- Это прямой способ выполнения SQL через PostgreSQL клиент (pg)

### Создание SQL файлов:
- **Все SQL запросы создавай в корне проекта** (не в папке sql/)
- После выполнения SQL запроса **удаляй файл**
- Если нужно несколько запросов - **объединяй их в один файл**
- Имя файла должно быть понятным (например: `database-maintenance.sql`)

### Структура подключения:
- База данных: PostgreSQL через Supabase
- Клиент: `pg` (Node.js) через `scripts/db.js`
- Переменные окружения: DATABASE_URL или DIRECT_URL в .env.local

### Критические правила работы с БД:
- **Всегда используй только receipt_id и realization_id** для связи receipt_items → receipts и realization_items → realization
- **Никогда не используй временную связку** (по времени создания) - это ненадежно и было удалено из всех API
- Всегда проверяй наличие колонок перед их использованием
- При создании поступлений всегда устанавливай `receipt_id: receipt.id`
- При создании реализаций всегда устанавливай `realization_id: realization.id`

### Связи между таблицами:
- `receipt_items.receipt_id` → `receipts.id` (обязательно, используется везде)
- `realization_items.realization_id` → `realization.id` (обязательно, используется везде)
- Используй только эти связи, без fallback режима

## Работа с размерами товаров

### Нормализация размеров:
- Для артикула W101 сохраняй полный размер с ростом: "L 160", "L 170", "M 160", "M 170", "S 160", "S 170", "XS 160", "XS 170"
- Для остальных товаров используй функцию `normalizeSizeCode` из `lib/utils/normalize.ts`
- При создании поступлений и реализаций всегда передавай артикул товара в `normalizeSizeCode` для корректной нормализации

## Проверка качества кода

### Перед завершением задачи:
- Запускай линтер: `npm run lint`
- Проверяй соответствие API и БД: `node scripts/check-api-db-compliance.js`
- Тестируй создание поступлений и реализаций: `node scripts/test-full-product-cycle.js`
- После изменений в API всегда проверяй работу endpoints

## Работа с тестами

- Создавай тестовые скрипты в папке `scripts/` с префиксом `test-`
- Тестовые скрипты должны автоматически очищать созданные данные
- После тестирования удаляй тестовые скрипты, если они были временными

## UI и оформление

- Использовать иконки только heroicons.com, никаких кастомных иконок
- Не менять оформление страниц и компонентов без разрешения

## Файлы и документы

- Удаляй временные файлы и логи после использования
- Не создавать инструкции и отчеты в виде файлов (кроме SQL миграций в папке `sql/`)
- SQL миграции сохраняй в папке `sql/` с понятными именами

## Система сборки и запуска

- После build автоматически запускай сервер командой `npm run dev`

## Git и версионный контроль

- Не создавать git commit и git push без разрешения

## Проверка соответствия API и БД

- Проверять APIs на соответствие БД и на наличие колонок и связей
- Использовать скрипт `scripts/check-api-db-compliance.js` для проверки
- При изменении API всегда проверять, что все используемые колонки существуют в БД
